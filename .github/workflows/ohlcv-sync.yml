name: OHLCV Sync

on:
  schedule:
    - cron: '40 6 * * *' # 15:40 KST every day
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r cloud_function/functions/requirements.txt

      - name: Write Firebase service account
        env:
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        run: |
          if [ -z "$FIREBASE_SERVICE_ACCOUNT" ]; then
            echo "FIREBASE_SERVICE_ACCOUNT secret is not configured." >&2
            exit 1
          fi
          printf '%s' "$FIREBASE_SERVICE_ACCOUNT" > "${RUNNER_TEMP}/firebase-key.json"

      - name: Run OHLCV sync
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ runner.temp }}/firebase-key.json
          HANKOOK_APP_KEY: ${{ secrets.HANKOOK_APP_KEY }}
          HANKOOK_APP_SECRET: ${{ secrets.HANKOOK_APP_SECRET }}
          HANKOOK_BASE_URL: ${{ secrets.HANKOOK_BASE_URL }}
        run: |
          if [ -z "$HANKOOK_APP_KEY" ] || [ -z "$HANKOOK_APP_SECRET" ]; then
            echo "한국투자증권 API 키/시크릿이 설정되지 않았습니다." >&2
            exit 1
          fi
          python cloud_function/functions/main.py
